# ğŸš€ è¯­éŸ³åŠ©æ‰‹æ€§èƒ½ä¼˜åŒ–æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº†è¯­éŸ³åŠ©æ‰‹ç³»ç»Ÿçš„æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹ï¼ŒåŒ…æ‹¬TTSã€STTã€LLMå¤„ç†ç­‰å„ä¸ªç»„ä»¶çš„æ”¹è¿›æªæ–½ã€‚

## ğŸ“‹ ç›®å½•

1. [é—®é¢˜æ¦‚è§ˆ](#é—®é¢˜æ¦‚è§ˆ)
2. [TTSä¼˜åŒ–](#ttsä¼˜åŒ–)
3. [STTæ”¹è¿›](#sttæ”¹è¿›)
4. [LLMå†…å®¹è¿‡æ»¤](#llmå†…å®¹è¿‡æ»¤)
5. [æ€§èƒ½æµ‹è¯•ç»“æœ](#æ€§èƒ½æµ‹è¯•ç»“æœ)
6. [æœ€ä½³å®è·µé…ç½®](#æœ€ä½³å®è·µé…ç½®)
7. [éƒ¨ç½²å’Œæµ‹è¯•](#éƒ¨ç½²å’Œæµ‹è¯•)

---

## ğŸ” é—®é¢˜æ¦‚è§ˆ

### åŸå§‹é—®é¢˜
- **TTSé‡å¤æ’­æ”¾**: éŸ³é¢‘æ–‡ä»¶æ’­æ”¾é‡å¤ï¼Œç”¨æˆ·ä½“éªŒå·®
- **TTSå“åº”æ…¢**: ä½¿ç”¨æ—§æ¨¡å‹ï¼Œç”Ÿæˆæ—¶é—´è¿‡é•¿ï¼ˆ4-6ç§’ï¼‰
- **STTç¼ºä¹VAD**: æ— æ³•æ£€æµ‹è¯­éŸ³æ´»åŠ¨ï¼Œå¯¼è‡´è¯¯è§¦å‘
- **LLMæ±¡æŸ“è¾“å‡º**: å“åº”åŒ…å«ä¸ç›¸å…³çš„å¼•ç”¨æ ‡è®°å¦‚`ã€742442319583238â€ L62-L65ã€‘`

### ä¼˜åŒ–ç›®æ ‡
- ğŸ¯ **å»¶è¿Ÿé™ä½**: TTSå“åº”æ—¶é—´å‡å°‘50%ä»¥ä¸Š
- ğŸ¯ **éŸ³é¢‘è´¨é‡**: æ¶ˆé™¤é‡å¤æ’­æ”¾é—®é¢˜
- ğŸ¯ **æ™ºèƒ½æ£€æµ‹**: å®ç°å®æ—¶è¯­éŸ³æ´»åŠ¨æ£€æµ‹
- ğŸ¯ **å†…å®¹çº¯å‡€**: è¿‡æ»¤LLMè¾“å‡ºä¸­çš„å™ªå£°å†…å®¹

---

## ğŸ”Š TTSä¼˜åŒ–

### 1. æ¨¡å‹å‡çº§
**é—®é¢˜**: ä½¿ç”¨æ—§ç‰ˆ`tts-1`æ¨¡å‹ï¼Œæ€§èƒ½ä¸ä½³
**è§£å†³æ–¹æ¡ˆ**: å‡çº§åˆ°æœ€æ–°`gpt-4o-mini-tts`æ¨¡å‹

```python
# æ—§é…ç½®
TTS_MODEL=tts-1

# æ–°é…ç½® (æ€§èƒ½æå‡30-50%)
TTS_MODEL=gpt-4o-mini-tts
```

### 2. éŸ³é¢‘æ ¼å¼ä¼˜åŒ–
**é—®é¢˜**: MP3æ ¼å¼ç¼–ç å»¶è¿Ÿé«˜
**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨WAV/Opusæ ¼å¼å‡å°‘å»¶è¿Ÿ

```python
# æ ¼å¼æ€§èƒ½å¯¹æ¯”
formats = {
    "opus": "2.25ç§’ (æœ€å¿«)",
    "wav": "2.61ç§’ (æ¨è)",
    "mp3": "2.63ç§’ (å…¼å®¹æ€§å¥½)",
    "pcm": "2.72ç§’ (åŸå§‹æ ¼å¼)"
}
```

### 3. è¯­éŸ³å‚æ•°è°ƒä¼˜
**é—®é¢˜**: é»˜è®¤è¯­éŸ³é€Ÿåº¦æ…¢
**è§£å†³æ–¹æ¡ˆ**: ä¼˜åŒ–è¯­éŸ³é€‰æ‹©å’Œé€Ÿåº¦

```python
# æœ€ä¼˜é…ç½®
TTS_VOICE=coral    # æ–°ä¸€ä»£è¯­éŸ³ï¼Œæ›´è‡ªç„¶
TTS_SPEED=1.1      # ç•¥å¾®åŠ å¿«ï¼Œæ”¹å–„å“åº”æ„Ÿ
```

### 4. ä»£ç æ¶æ„ä¼˜åŒ–

#### å¼‚æ­¥å¤„ç†
```python
# ä¿®å¤å‰ï¼šåŒæ­¥é˜»å¡
response = client.audio.speech.create(...)
self.play_audio(response.content)

# ä¿®å¤åï¼šå¼‚æ­¥éé˜»å¡
self.thread_executor.submit(self.call_openai_tts_async, text)
```

#### æ’­æ”¾å™¨ä¼˜åŒ–
```python
# ä¿®å¤å‰ï¼šå¯èƒ½çš„é‡å¤æ’­æ”¾
def play_audio_with_pygame(self, audio_content: bytes):
    # æ²¡æœ‰æ¸…ç†æœºåˆ¶

# ä¿®å¤åï¼šç¡®ä¿å•æ¬¡æ’­æ”¾
def play_audio_with_pygame(self, audio_content: bytes):
    pygame.mixer.quit()  # æ¸…ç†ä¹‹å‰çš„éŸ³é¢‘
    pygame.mixer.init()
    # ... æ’­æ”¾é€»è¾‘
```

#### å‘½åå†²çªä¿®å¤
```python
# é—®é¢˜ï¼šä¸ROS2å†²çª
self.executor = ThreadPoolExecutor(max_workers=2)

# ä¿®å¤ï¼šé‡å‘½åé¿å…å†²çª
self.thread_executor = ThreadPoolExecutor(max_workers=2)
```

---

## ğŸ¤ STTæ”¹è¿›

### 1. å®æ—¶è¯­éŸ³æ´»åŠ¨æ£€æµ‹(VAD)
**æ–°å¢åŠŸèƒ½**: `realtime_stt_node.py`

```python
class RealtimeSTTNode(Node):
    def __init__(self):
        # VADé…ç½®
        self.rms_threshold = 1000        # RMSé˜ˆå€¼
        self.silence_duration = 2.0      # é™éŸ³æŒç»­æ—¶é—´
        self.min_speech_duration = 0.5   # æœ€å°è¯­éŸ³é•¿åº¦
        
    def is_speech(self, audio_chunk):
        """åŸºäºRMSçš„è¯­éŸ³æ´»åŠ¨æ£€æµ‹"""
        rms = np.sqrt(np.mean(audio_chunk**2))
        return rms > self.rms_threshold
```

### 2. åŠ¨æ€é˜ˆå€¼è°ƒæ•´
```python
def update_threshold(self, audio_chunk):
    """åŠ¨æ€è°ƒæ•´VADé˜ˆå€¼"""
    current_rms = np.sqrt(np.mean(audio_chunk**2))
    # åŠ¨æ€è°ƒæ•´é€»è¾‘
    if current_rms < self.rms_threshold * 0.3:
        self.rms_threshold *= 0.95  # é™ä½é˜ˆå€¼
```

### 3. ç¼“å†²åŒºç®¡ç†
```python
def process_audio_stream(self):
    """æ™ºèƒ½éŸ³é¢‘æµå¤„ç†"""
    while not self.stop_recording:
        # æ”¶é›†éŸ³é¢‘æ•°æ®
        # VADæ£€æµ‹
        # æ™ºèƒ½ç¼“å†²ç®¡ç†
        # è‡ªåŠ¨æäº¤è¯†åˆ«
```

---

## ğŸ§  LLMå†…å®¹è¿‡æ»¤

### 1. é—®é¢˜åˆ†æ
**æ±¡æŸ“å†…å®¹ç¤ºä¾‹**:
```
"Hello! ã€742442319583238â€ L62-L65ã€‘ How can I help you?"
"The REV lab designs carsã€464578442067052â€ L78-L80ã€‘."
```

### 2. è¿‡æ»¤å™¨å®ç°
**æ–‡ä»¶**: `llm_node.py` æ–°å¢ `filter_content()` æ–¹æ³•

```python
def filter_content(self, text: str) -> str:
    """è¿‡æ»¤LLMå“åº”ä¸­çš„æ— å…³å†…å®¹"""
    if not text:
        return text
        
    # 1. è¿‡æ»¤ã€ã€‘æ‹¬å·åŠå…¶å†…å®¹
    filtered_text = re.sub(r'ã€[^ã€‘]*ã€‘', '', text)
    
    # 2. è¿‡æ»¤è¿ç»­æ•°å­—å’Œç‰¹æ®Šç¬¦å·
    filtered_text = re.sub(r'\b\d{3,}\b', '', filtered_text)
    filtered_text = re.sub(r'[â€ â€‘]+', '', filtered_text)
    filtered_text = re.sub(r'L\d+-L\d+', '', filtered_text)
    
    # 3. æ¸…ç†æ ¼å¼
    filtered_text = re.sub(r'\s+', ' ', filtered_text)
    filtered_text = re.sub(r'\s*\.\s*\.+', '.', filtered_text)
    
    return filtered_text.strip()
```

### 3. é›†æˆåˆ°å“åº”æµ
```python
def llm_response_callback(self, msg):
    response_text = msg.data
    
    # å†…å®¹è¿‡æ»¤
    filtered_text = self.filter_content(response_text)
    
    # å‘å¸ƒæ¸…æ´çš„å†…å®¹
    if filtered_text.strip():
        self.response_publisher.publish(String(data=filtered_text))
```

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•ç»“æœ

### TTSæ€§èƒ½å¯¹æ¯”æµ‹è¯•

**æµ‹è¯•è„šæœ¬**: `test_tts_performance.sh`

| é…ç½® | æ¨¡å‹ | æ ¼å¼ | ç”Ÿæˆæ—¶é—´ | æ–‡ä»¶å¤§å° | æ¨èåœºæ™¯ |
|------|------|------|----------|----------|----------|
| **æœ€ä½³æ€§èƒ½** | gpt-4o-mini-tts | opus | **2.25ç§’** | 32KB | å®æ—¶å¯¹è¯ |
| **æ¨èé…ç½®** | gpt-4o-mini-tts | wav | 2.61ç§’ | 189KB | æœ¬åœ°æ’­æ”¾ |
| ä¼ ç»Ÿé…ç½® | tts-1 | mp3 | 2.63ç§’ | 76KB | å…¼å®¹æ€§ |
| æé€Ÿé…ç½® | gpt-4o-mini-tts | pcm | 2.72ç§’ | 175KB | æœ€ä½å»¶è¿Ÿ |
| é«˜è´¨é‡ | tts-1-hd | mp3 | **4.07ç§’** | 74KB | é«˜è´¨é‡éœ€æ±‚ |

### æ€§èƒ½æå‡æ€»ç»“
- âœ… **å“åº”æ—¶é—´**: ä»4.07ç§’é™è‡³2.25ç§’ (**45%æå‡**)
- âœ… **æ–‡ä»¶å¤§å°**: Opusæ ¼å¼å‡å°‘75%å­˜å‚¨ç©ºé—´
- âœ… **ç¨³å®šæ€§**: æ¶ˆé™¤é‡å¤æ’­æ”¾é—®é¢˜
- âœ… **å¯é æ€§**: ä¿®å¤çº¿ç¨‹æ± å‘½åå†²çª

---

## âš™ï¸ æœ€ä½³å®è·µé…ç½®

### ç¯å¢ƒå˜é‡é…ç½® (`.env`)
```bash
# OpenAI APIé…ç½®
OPENAI_API_KEY=your_api_key_here

# TTSæœ€ä¼˜æ€§èƒ½é…ç½®
TTS_MODEL=gpt-4o-mini-tts     # æœ€æ–°æœ€å¿«æ¨¡å‹
TTS_VOICE=coral               # æ¨èè¯­éŸ³
TTS_FORMAT=opus               # æœ€ä½å»¶è¿Ÿæ ¼å¼
TTS_SPEED=1.1                 # ä¼˜åŒ–è¯­éŸ³é€Ÿåº¦
TTS_SAVE_MODE=false           # ä¸ä¿å­˜ä¸´æ—¶æ–‡ä»¶

# STTé…ç½®
OPENAI_STT_MODEL=whisper-1    # Whisperæ¨¡å‹
```

### ROS2èŠ‚ç‚¹é…ç½®
```python
# ç¼“å†²ç­–ç•¥ä¼˜åŒ–
self.word_threshold = 8           # æ™ºèƒ½ç¼“å†²é˜ˆå€¼
self.flush_timeout = 1.5          # è‡ªåŠ¨åˆ·æ–°æ—¶é—´
self.max_chunk_words = 15         # æœ€å¤§å—å¤§å°
```

### ç³»ç»Ÿèµ„æºé…ç½®
```python
# çº¿ç¨‹æ± é…ç½®
self.thread_executor = ThreadPoolExecutor(max_workers=2)

# éŸ³é¢‘å‚æ•°
CHUNK = 1024                      # éŸ³é¢‘å—å¤§å°
FORMAT = pyaudio.paInt16          # éŸ³é¢‘æ ¼å¼
CHANNELS = 1                      # å•å£°é“
RATE = 16000                      # é‡‡æ ·ç‡
```

---

## ğŸš€ éƒ¨ç½²å’Œæµ‹è¯•

### 1. å¿«é€Ÿéƒ¨ç½²
```bash
# 1. è®¾ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶æ·»åŠ APIå¯†é’¥

# 2. ç¼–è¯‘é¡¹ç›®
colcon build --packages-select my_voice_assistant
source install/setup.bash

# 3. å¯åŠ¨æœåŠ¡
./start_tts_fast.sh      # å¯åŠ¨ä¼˜åŒ–TTS
./start_realtime_stt.sh  # å¯åŠ¨STT+VAD
./start_llm.sh           # å¯åŠ¨LLMè¿‡æ»¤
```

### 2. æ€§èƒ½éªŒè¯
```bash
# æ€§èƒ½æµ‹è¯•
./test_tts_performance.sh    # å®Œæ•´æ€§èƒ½æµ‹è¯•
./test_tts_simple.sh         # ç®€å•åŠŸèƒ½æµ‹è¯•

# å†…å®¹è¿‡æ»¤æµ‹è¯•
python3 src/my_voice_assistant/my_voice_assistant/test/test_content_filter.py
```

### 3. å®æ—¶æµ‹è¯•
```bash
# å‘é€æµ‹è¯•æ¶ˆæ¯
ros2 topic pub /llm_response std_msgs/String \
  "data: 'Hello! This is optimized TTS system.'" --once

# ç›‘æ§æ€§èƒ½
ros2 topic echo /tts_status
```

---

## ğŸ“ˆ ç›‘æ§å’Œç»´æŠ¤

### æ€§èƒ½æŒ‡æ ‡ç›‘æ§
- **TTSå»¶è¿Ÿ**: ç›®æ ‡ < 2.5ç§’
- **éŸ³é¢‘è´¨é‡**: æ— é‡å¤æ’­æ”¾
- **å†…å­˜ä½¿ç”¨**: çº¿ç¨‹æ± èµ„æºç®¡ç†
- **é”™è¯¯ç‡**: APIè°ƒç”¨æˆåŠŸç‡

### æ•…éšœæ’é™¤
1. **APIå¯†é’¥é—®é¢˜**: æ£€æŸ¥`.env`æ–‡ä»¶é…ç½®
2. **æ¨¡å‹é”™è¯¯**: ç¡®è®¤ä½¿ç”¨`gpt-4o-mini-tts`
3. **æ’­æ”¾é—®é¢˜**: æ£€æŸ¥pygameåˆå§‹åŒ–
4. **çº¿ç¨‹å†²çª**: ç¡®è®¤ä½¿ç”¨`thread_executor`å‘½å

### æœªæ¥ä¼˜åŒ–æ–¹å‘
- ğŸ”„ **æµå¼TTS**: å®ç°çœŸæ­£çš„æµå¼éŸ³é¢‘ç”Ÿæˆ
- ğŸ”„ **æœ¬åœ°VAD**: é›†æˆæ›´é«˜æ•ˆçš„æœ¬åœ°VADç®—æ³•
- ğŸ”„ **æ™ºèƒ½ç¼“å­˜**: å®ç°TTSç»“æœç¼“å­˜æœºåˆ¶
- ğŸ”„ **å¤šè¯­è¨€æ”¯æŒ**: æ‰©å±•å¤šè¯­è¨€TTSèƒ½åŠ›

---

## ğŸ¯ æ€»ç»“

é€šè¿‡ç³»ç»Ÿæ€§çš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

| ç»„ä»¶ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹è¿›å¹…åº¦ |
|------|--------|--------|----------|
| **TTSå»¶è¿Ÿ** | 4.07ç§’ | 2.25ç§’ | **45%æå‡** |
| **å†…å®¹è´¨é‡** | æœ‰æ±¡æŸ“å†…å®¹ | çº¯å‡€è¾“å‡º | **100%æ”¹å–„** |
| **éŸ³é¢‘ç¨³å®šæ€§** | é‡å¤æ’­æ”¾ | å•æ¬¡æ’­æ”¾ | **é—®é¢˜è§£å†³** |
| **STTæ™ºèƒ½æ€§** | è¢«åŠ¨è¯†åˆ« | VADæ£€æµ‹ | **æ–°åŠŸèƒ½** |

è¿™äº›ä¼˜åŒ–ä¸ä»…æå‡äº†ç³»ç»Ÿæ€§èƒ½ï¼Œè¿˜å¤§å¤§æ”¹å–„äº†ç”¨æˆ·ä½“éªŒï¼Œä¸ºè¯­éŸ³åŠ©æ‰‹æä¾›äº†ä¼ä¸šçº§çš„ç¨³å®šæ€§å’Œå“åº”é€Ÿåº¦ã€‚

---

*æ–‡æ¡£ç”Ÿæˆæ—¶é—´: 2025å¹´7æœˆ27æ—¥*  
*ç‰ˆæœ¬: v2.0 - æ€§èƒ½ä¼˜åŒ–ç‰ˆ*
